#!/bin/bash
# post-checkout hook: Block branch checkouts in main worktree
#
# This hook prevents checking out branches other than main when working
# in the main repository worktree. Feature worktrees are unaffected.
#
# The hook automatically reverts the checkout and switches back to main.

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Hook parameters
prev_head=$1
new_head=$2
is_branch_checkout=$3

# Only act on branch checkouts (not file checkouts)
if [ "$is_branch_checkout" != "1" ]; then
    exit 0
fi

# Get the current branch after checkout
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# If we're on main, allow it
if [ "$current_branch" = "main" ]; then
    exit 0
fi

# Get the absolute path of the current worktree
current_worktree=$(git rev-parse --show-toplevel)

# Check if we're in the main worktree (not a feature worktree)
if [[ ! "$current_worktree" =~ /.docimp-wt/ ]]; then
    # We're in the main worktree and not on main branch - block this!
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ CHECKOUT BLOCKED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Cannot check out branch '$current_branch' in the main worktree.${NC}"
    echo ""
    echo "The main worktree should always remain on the main branch."
    echo "All development work should be done in feature worktrees."
    echo ""
    echo "To work on a feature branch, create a new worktree:"
    echo "  python3 scripts/create_worktree.py <worktree-name> <branch-name>"
    echo ""
    echo "Example:"
    echo "  python3 scripts/create_worktree.py issue-260 issue-260-fix-bug"
    echo ""
    echo -e "${YELLOW}Automatically reverting to main branch...${NC}"
    echo ""

    # Revert back to main branch
    git checkout main

    exit 1
fi

# We're in a feature worktree - allow the checkout
exit 0
